<!doctype html>
<html lang="en">
	<head>
		<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.21/b-1.6.2/datatables.min.css"/>
		<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='stock_info.css') }}">

		<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
		<script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.21/b-1.6.2/b-html5-1.6.2/datatables.min.js"></script>

		<meta charset="utf-8">
		<title>Stock Information</title>
	</head>
	<body>
		<div class="container">
			<div id="button_bar"></div>
			<div id="table_div">
				<table id="mytable" class="display" style="width:100%">
					<thead><tr></tr></thead>
					<tfoot><tr></tr></tfoot>
				</table>
			</div>
		</div>
		<script type="text/javascript">
			function getData(cb_func) { //cb_func means callback function
				$.ajax({
				  url: "/stock_columns",
				  success: cb_func
				});
			}

			var createdRowFunc = function( row, data, index ){
				var color = 'black';
				if (data["change"] < 0) {
					color = 'red';
					$('td', row).eq(2).addClass(color);
					$('td', row).eq(3).addClass(color);
					$('td', row).eq(4).addClass(color);
				}
				if (data["change"] > 0) {
					color = 'green';
					$('td', row).eq(2).addClass(color);
					$('td', row).eq(3).addClass(color);
					$('td', row).eq(4).addClass(color);
				}

				if (data["dcf"] - data["price"] > 0) {
					color = 'green';
					$('td', row).eq(6).addClass(color);
				} else {
					color = 'black';
					$('td', row).eq(6).addClass(color);
				}
			};

			$(document).ready( function () {
				getData(function(response){
					data = JSON.parse(response);
					columnsDict = data.columns;

					var columns = [];
					for (var i in columnsDict) {
      					columns.push({data: i});
      					str = '<th>' + columnsDict[i] + '</th>';
      					$(str).appendTo('#mytable' + '>thead>tr');
      					$(str).appendTo('#mytable' + '>tfoot>tr');
    				}

    				var table = $('#mytable').DataTable({
						ajax: {{ dataURL|tojson }},
						columns: columns,
						paging: true,
						ordering: true,
						columnDefs: [
							{ className: "dt-center", targets: "_all" },
						],
						createdRow: createdRowFunc
					});

					// Add buttons to the table
					new $.fn.dataTable.Buttons( table, {
						buttons: [
							{
								text: 'Reload',
								action: function ( e, dt, node, config ) {
									dt.ajax.reload();
								}
							},
							{
								extend: 'csvHtml5',
								text: 'CSV',
							}
						]
					} );
					table.buttons().container().appendTo($('#button_bar'));
				});

			} );
		</script>
	</body>
</html>